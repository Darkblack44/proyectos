<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Calor de Colombia - Distribución por Municipios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            background-color: #ffffff;
            border-bottom: 1px solid #e1e4e8;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        #map-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
        }
        
        #map {
            height: 600px;
            flex: 2;
            min-width: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background-color: #f8f9fa;
        }
        
        #sidebar {
            flex: 1;
            min-width: 250px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 600px;
            overflow-y: auto;
        }
        
        .stats-container {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2980b9;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .top-list {
            margin-top: 20px;
        }
        
        .top-list h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 2px solid #e1e4e8;
            padding-bottom: 5px;
        }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .item-name {
            font-weight: 500;
        }
        
        .item-value {
            font-weight: bold;
            color: #2980b9;
        }
        
        .color-legend {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
        }
        
        .color-legend h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            background-color: #ffffff;
            border-top: 1px solid #e1e4e8;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: #2980b9;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* Estilos para el menú desplegable de lugares */
        .location-selector {
            margin: 20px 0;
            position: relative;
        }
        
        .dropdown-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 15px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        
        .dropdown-btn:hover {
            background-color: #2171b5;
        }
        
        .dropdown-icon {
            font-size: 0.8rem;
            margin-left: 10px;
            transition: transform 0.3s;
        }
        
        .dropdown-icon.open {
            transform: rotate(180deg);
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 300px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1010;
            overflow: hidden;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        #lugar-search {
            width: 100%;
            padding: 10px;
            border: none;
            border-bottom: 1px solid #e1e4e8;
            font-size: 0.9rem;
        }
        
        #lugares-list {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        #lugares-list::-webkit-scrollbar {
            width: 6px;
        }
        
        #lugares-list::-webkit-scrollbar-thumb {
            background-color: #2980b9;
            border-radius: 3px;
        }
        
        #lugares-list::-webkit-scrollbar-track {
            background-color: #f0f2f5;
        }
        
        .lugar-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #f0f2f5;
        }
        
        .lugar-item:hover {
            background-color: #f0f2f5;
        }
        
        .lugar-item .count {
            color: #2980b9;
            font-weight: bold;
        }
        
        /* Estilos para elementos clicables en los rankings */
        .clickable-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e1e4e8;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .clickable-item:hover {
            background-color: #f0f2f5;
            padding-left: 5px;
        }
        
        .clickable-item:last-child {
            border-bottom: none;
        }
        
        .clickable-item .item-name {
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .clickable-item .item-value {
            font-weight: bold;
            color: #2980b9;
        }
        
        .marker-active {
            z-index: 1000 !important;
        }
        
        .info-box {
            padding: 8px 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .info-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .info-content {
            line-height: 1.4;
        }
        
        .info-value {
            font-weight: bold;
            color: #2980b9;
        }
        
        .leaflet-tooltip {
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
        }
        
        #file-input-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        
        #file-input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        #file-input-container input {
            margin-bottom: 5px;
        }
        
        /* Estilos para el botón de pantalla completa */
        .fullscreen-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            color: #2980b9;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .fullscreen-button:hover {
            background-color: #f0f2f5;
        }
        
        .fullscreen-button i {
            margin-right: 5px;
        }
        
        .fullscreen-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232980b9'%3E%3Cpath d='M3 3h7v2H5v5H3V3zm18 0h-7v2h5v5h2V3zM3 21h7v-2H5v-5H3v7zm18 0h-7v-2h5v-5h2v7z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            display: inline-block;
        }
        
        .fullscreen-exit-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232980b9'%3E%3Cpath d='M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            display: inline-block;
        }
        
        /* Estilo para el mapa en modo pantalla completa */
        .map-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            border-radius: 0 !important;
        }
        
        /* Estilos para el panel de estadísticas en pantalla completa */
        .stats-panel {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100vh;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .stats-panel.show {
            transform: translateX(0);
        }
        
        .stats-panel.active {
            display: block;
        }
        
        .stats-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #2980b9;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10001;
            display: none;
            transition: opacity 0.5s ease;
        }
        
        .stats-toggle.active {
            display: flex;
        }
        
        .stats-toggle.fade-out {
            opacity: 0.3;
        }
        
        .stats-toggle:hover {
            opacity: 1;
        }
        
        .stats-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        /* Estilo para los departamentos desplegables */
        .departamentos-dropdown {
            margin: 20px 0;
            position: relative;
        }
        
        .departamentos-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .departamento-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .departamento-item:hover {
            background-color: #e1e4e8;
        }
        
        .departamento-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            #map-container {
                flex-direction: column;
            }
            
            #map {
                height: 400px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Mapa de Calor de Colombia</h1>
        <div class="subtitle">Distribución geográfica de registros</div>
    </header>

    <div id="file-input-container">
        <label>Seleccione el archivo Datos.txt</label>
        <input type="file" id="file-input" accept=".txt">
    </div>

    <div class="container">
        <div id="map-container">
            <div id="map">
                <div class="loading">
                    <div class="loading-text">Cargando mapa y procesando datos...</div>
                </div>
                <button id="fullscreen-btn" class="fullscreen-button">
                    <span class="fullscreen-icon"></span>
                    Pantalla completa
                </button>
            </div>
            <div id="sidebar">
                <h2>Estadísticas</h2>
                <div id="stats">
                    <div class="list-item">
                        <span class="item-name">Total de registros:</span>
                        <span id="total-registros" class="item-value">3,159</span>
                    </div>
                    <div class="list-item">
                        <span class="item-name">Municipios únicos:</span>
                        <span id="total-municipios" class="item-value">...</span>
                    </div>
                    <div class="list-item">
                        <span class="item-name">Departamentos:</span>
                        <span id="total-departamentos" class="item-value">...</span>
                    </div>
                </div>
                
                <div class="departamentos-dropdown">
                    <h3>Departamentos (<span id="dept-count">0</span>/<span id="dept-total">32</span>)</h3>
                    <div id="departamentos-list" class="departamentos-list">
                        <div class="loading">Cargando departamentos...</div>
                    </div>
                </div>
                
                <div class="location-selector">
                    <button id="lugares-dropdown-btn" class="dropdown-btn">
                        <span id="lugares-count">Todos los lugares</span>
                        <span class="dropdown-icon">▼</span>
                    </button>
                    <div id="lugares-dropdown-content" class="dropdown-content">
                        <input type="text" id="lugar-search" placeholder="Buscar lugar...">
                        <div id="lugares-list">
                            <div class="loading">Cargando lugares...</div>
                        </div>
                    </div>
                </div>
                
                <div class="top-list">
                    <h3>Top 10 Municipios</h3>
                    <div id="top-municipios">
                        <div class="loading">Cargando...</div>
                    </div>
                </div>
                
                <div class="top-list">
                    <h3>Top 5 Departamentos</h3>
                    <div id="top-departamentos">
                        <div class="loading">Cargando...</div>
                    </div>
                </div>
                
                <div class="color-legend">
                    <h3>Leyenda</h3>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #9ecae1;"></div>
                        <span>Baja concentración</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #4292c6;"></div>
                        <span>Media concentración</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #084594;"></div>
                        <span>Alta concentración</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #ff5050; border-radius: 50%;"></div>
                        <span>Municipios principales</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel de estadísticas para modo pantalla completa -->
        <div id="stats-panel" class="stats-panel">
            <button id="stats-close" class="stats-close">×</button>
            <h2>Estadísticas</h2>
            <div id="stats-fullscreen">
                <div class="list-item">
                    <span class="item-name">Total de registros:</span>
                    <span id="total-registros-fs" class="item-value">3,159</span>
                </div>
                <div class="list-item">
                    <span class="item-name">Municipios únicos:</span>
                    <span id="total-municipios-fs" class="item-value">...</span>
                </div>
                <div class="list-item">
                    <span class="item-name">Departamentos:</span>
                    <span id="total-departamentos-fs" class="item-value">...</span>
                </div>
            </div>
            
            <div class="departamentos-dropdown">
                <h3>Departamentos (<span id="dept-count-fs">0</span>/<span id="dept-total-fs">32</span>)</h3>
                <div id="departamentos-list-fs" class="departamentos-list">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
            
            <div class="location-selector">
                <button id="lugares-dropdown-btn-fs" class="dropdown-btn">
                    <span id="lugares-count-fs">Todos los lugares</span>
                    <span class="dropdown-icon">▼</span>
                </button>
                <div id="lugares-dropdown-content-fs" class="dropdown-content">
                    <input type="text" id="lugar-search-fs" placeholder="Buscar lugar...">
                    <div id="lugares-list-fs">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
            
            <div class="top-list">
                <h3>Top 10 Municipios</h3>
                <div id="top-municipios-fs">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
            
            <div class="top-list">
                <h3>Top 5 Departamentos</h3>
                <div id="top-departamentos-fs">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
            
            <div class="color-legend">
                <h3>Leyenda</h3>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #9ecae1;"></div>
                    <span>Baja concentración</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #4292c6;"></div>
                    <span>Media concentración</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #084594;"></div>
                    <span>Alta concentración</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #ff5050; border-radius: 50%;"></div>
                    <span>Municipios principales</span>
                </div>
            </div>
        </div>
        
        <!-- Botón para mostrar/ocultar estadísticas en pantalla completa -->
        <button id="stats-toggle" class="stats-toggle">≡</button>
        
        <div class="stats-container">
            <div class="stat-card">
                <div id="stat-principal" class="stat-value">FUSAGASUGA</div>
                <div class="stat-label">Municipio con mayor número de registros</div>
            </div>
            <div class="stat-card">
                <div id="stat-principal-value" class="stat-value">...</div>
                <div class="stat-label">Cantidad de registros</div>
            </div>
            <div class="stat-card">
                <div id="stat-depto" class="stat-value">Cundinamarca</div>
                <div class="stat-label">Departamento con mayor número de registros</div>
            </div>
            <div class="stat-card">
                <div id="stat-depto-value" class="stat-value">...</div>
                <div class="stat-label">Cantidad de registros</div>
            </div>
        </div>
    </div>

    <footer>
        Mapa de Calor de Colombia - Visualización de datos geográficos - 2025
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        // Datos de Colombia - Contorno principal simplificado
        const colombiaCoords = [
            [-77.4, 8.7], [-76.8, 8.9], [-76.2, 9.3], [-75.6, 9.6], [-75.0, 10.0], 
            [-74.8, 10.5], [-74.3, 10.8], [-74.0, 11.1], [-73.3, 11.3], [-72.9, 11.5],
            [-72.5, 11.8], [-72.0, 12.2], [-71.6, 12.1], [-71.2, 11.8],
            [-70.8, 11.4], [-70.3, 11.0], [-70.2, 10.7], [-70.1, 10.1], [-70.0, 9.5],
            [-69.8, 9.0], [-69.5, 8.5], [-69.8, 8.0], [-70.0, 7.5], [-70.2, 7.0],
            [-70.5, 6.5], [-70.8, 6.0], [-70.9, 5.5], [-71.0, 5.0], [-71.3, 4.5],
            [-71.2, 4.0], [-71.0, 3.5], [-70.5, 3.0], [-70.0, 2.5], [-69.5, 2.0],
            [-69.0, 1.5], [-69.2, 1.0], [-69.5, 0.5], [-69.8, 0.0], [-70.1, -0.5],
            [-70.5, -1.0], [-70.8, -1.5], [-71.2, -2.0], [-71.5, -2.5], [-72.0, -3.0],
            [-72.5, -3.5], [-73.0, -3.8], [-73.5, -3.9], [-74.0, -4.0],
            [-74.5, -3.8], [-75.0, -3.5], [-75.5, -3.0], [-76.0, -2.5], [-76.5, -2.0],
            [-77.0, -1.5], [-77.5, -1.0], [-78.0, -0.5], [-78.5, 0.0], [-78.8, 0.5],
            [-79.0, 1.0], [-79.2, 1.5], [-79.1, 2.0],
            [-79.0, 2.5], [-78.8, 3.0], [-78.5, 3.5], [-78.2, 4.0], [-78.0, 4.5],
            [-77.8, 5.0], [-77.6, 5.5], [-77.4, 6.0], [-77.2, 6.5], [-77.3, 7.0],
            [-77.4, 7.5], [-77.5, 8.0], [-77.4, 8.5], [-77.4, 8.7]
        ];

        // Lista de departamentos oficiales de Colombia con sus capitales
        const departamentosOficiales = {
            'Amazonas': 'Leticia',
            'Antioquia': 'Medellín',
            'Arauca': 'Arauca',
            'Atlántico': 'Barranquilla',
            'Bolívar': 'Cartagena',
            'Boyacá': 'Tunja',
            'Caldas': 'Manizales',
            'Caquetá': 'Florencia',
            'Casanare': 'Yopal',
            'Cauca': 'Popayán',
            'Cesar': 'Valledupar',
            'Chocó': 'Quibdó',
            'Córdoba': 'Montería',
            'Cundinamarca': 'Bogotá',
            'Guainía': 'Inírida',
            'Guaviare': 'San José del Guaviare',
            'Huila': 'Neiva',
            'La Guajira': 'Riohacha',
            'Magdalena': 'Santa Marta',
            'Meta': 'Villavicencio',
            'Nariño': 'Pasto',
            'Norte de Santander': 'Cúcuta',
            'Putumayo': 'Mocoa',
            'Quindío': 'Armenia',
            'Risaralda': 'Pereira',
            'San Andrés y Providencia': 'San Andrés',
            'Santander': 'Bucaramanga',
            'Sucre': 'Sincelejo',
            'Tolima': 'Ibagué',
            'Valle del Cauca': 'Cali',
            'Vaupés': 'Mitú',
            'Vichada': 'Puerto Carreño'
        };
        
        // Mapeo inverso de códigos DANE a nombres oficiales de departamentos
        const codigosANombresOficiales = {
            '91': 'Amazonas',
            '05': 'Antioquia',
            '81': 'Arauca',
            '08': 'Atlántico',
            '13': 'Bolívar',
            '15': 'Boyacá',
            '17': 'Caldas',
            '18': 'Caquetá',
            '85': 'Casanare',
            '19': 'Cauca',
            '20': 'Cesar',
            '27': 'Chocó',
            '23': 'Córdoba',
            '25': 'Cundinamarca',
            '94': 'Guainía',
            '95': 'Guaviare',
            '41': 'Huila',
            '44': 'La Guajira',
            '47': 'Magdalena',
            '50': 'Meta',
            '52': 'Nariño',
            '54': 'Norte de Santander',
            '86': 'Putumayo',
            '63': 'Quindío',
            '66': 'Risaralda',
            '88': 'San Andrés y Providencia',
            '68': 'Santander',
            '70': 'Sucre',
            '73': 'Tolima',
            '76': 'Valle del Cauca',
            '97': 'Vaupés',
            '99': 'Vichada'
        };
        
        // Total de departamentos oficiales
        const TOTAL_DEPARTAMENTOS_OFICIALES = Object.keys(departamentosOficiales).length;

        // Coordenadas de los principales departamentos (centroides aproximados)
        const coordsDepartamentos = {
            '05': [6.9, -75.5],  // Antioquia
            '08': [10.6, -74.9],  // Atlántico
            '11': [4.6, -74.1],  // Bogotá D.C.
            '13': [9.7, -75.0],  // Bolívar
            '15': [5.8, -73.0],  // Boyacá
            '17': [5.3, -75.4],  // Caldas
            '18': [1.3, -75.5],  // Caquetá
            '19': [2.5, -76.8],  // Cauca
            '20': [9.3, -73.5],  // Cesar
            '23': [8.7, -75.9],  // Córdoba
            '25': [5.0, -74.0],  // Cundinamarca
            '27': [6.0, -77.0],  // Chocó
            '41': [2.5, -75.3],  // Huila
            '44': [11.5, -72.8],  // La Guajira
            '47': [10.3, -74.1],  // Magdalena
            '50': [3.8, -73.0],  // Meta
            '52': [1.2, -77.5],  // Nariño
            '54': [7.9, -72.8],  // Norte de Santander
            '63': [4.5, -75.7],  // Quindío
            '66': [5.0, -76.0],  // Risaralda
            '68': [6.9, -73.1],  // Santander
            '70': [9.3, -75.1],  // Sucre
            '73': [4.0, -75.2],  // Tolima
            '76': [3.8, -76.5],  // Valle del Cauca
            '81': [6.6, -71.0],  // Arauca
            '85': [5.3, -72.3],  // Casanare
            '86': [0.7, -76.5],  // Putumayo
            '91': [-1.0, -71.5],  // Amazonas
            '94': [2.1, -69.5],  // Guainía
            '95': [2.3, -72.3],  // Guaviare
            '97': [0.5, -70.5],  // Vaupés
            '99': [5.0, -69.0]   // Vichada
        };

        // Coordenadas de los principales municipios
        const coordsMunicipios = {
            'BOGOTA D.C.': [4.65, -74.08],
            'FUSAGASUGA': [4.34, -74.36],
            'ARBELAEZ': [4.27, -74.41],
            'SILVANIA': [4.40, -74.38],
            'PASCA': [4.31, -74.30],
            'SAN BERNARDO': [4.18, -74.42],
            'GIRARDOT': [4.30, -74.80],
            'SOACHA': [4.58, -74.21],
            'GRANADA': [4.52, -74.35],
            'PANDI': [4.19, -74.49],
            'TIBACUY': [4.35, -74.45],
            'VENECIA': [4.08, -74.47],
            'CABRERA': [3.98, -74.48],
            'VIOTA': [4.44, -74.52],
            'LA MESA': [4.63, -74.46],
            'SIBATE': [4.49, -74.26],
            'MADRID': [4.73, -74.27],
            'FACATATIVA': [4.81, -74.35],
            'ZIPAQUIRA': [5.02, -74.00],
            'MEDELLIN': [6.25, -75.56],
            'CALI': [3.45, -76.53],
            'BARRANQUILLA': [10.96, -74.78],
            'BUCARAMANGA': [7.12, -73.12],
            'CARTAGENA': [10.39, -75.51],
            'IBAGUE': [4.43, -75.23],
            'NEIVA': [2.93, -75.28],
            'VILLAVICENCIO': [4.15, -73.63],
            'PEREIRA': [4.81, -75.69],
            'SANTA MARTA': [11.24, -74.20],
            'TUNJA': [5.54, -73.36],
            'PASTO': [1.21, -77.28],
            'CUCUTA': [7.89, -72.50],
            'MONTERIA': [8.75, -75.88],
            'FLORENCIA': [1.61, -75.60],
            'EL COLEGIO': [4.58, -74.44],
            'APARTADO': [7.88, -76.63]
        };

        // Datos simulados de municipios y conteos (serán reemplazados por datos reales)
        let datos = [];
        
        // Procesar los datos del archivo Datos.txt
        function procesarDatos(texto) {
            const lineas = texto.trim().split('\n');
            const datos = [];
            
            lineas.forEach(linea => {
                if (!linea.trim()) return;
                
                const partes = linea.trim().split('\t');
                if (partes.length >= 2 && partes[0].trim() && partes[1].trim()) {
                    let codigo = partes[0].trim();
                    const municipio = partes[1].trim();
                    
                    // Manejar casos donde el código no es numérico
                    if (!/^\d+$/.test(codigo) && codigo.length > 0) {
                        const numeros = codigo.match(/\d+/);
                        if (numeros) {
                            codigo = numeros[0];
                        } else {
                            codigo = "99999";  // código no identificado
                        }
                    }
                    
                    // Extraer código de departamento (primeros 2 dígitos)
                    const codDepartamento = codigo.length >= 2 ? codigo.substring(0, 2) : '99';
                    
                    datos.push({
                        codigo,
                        municipio,
                        codDepartamento
                    });
                }
            });
            
            return datos;
        }

        // Configuración inicial del mapa
        const map = L.map('map').setView([4.5709, -74.2973], 6);
        
        // Añadir capa base de OpenStreetMap
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Crear contorno de Colombia
        const colombiaPolygon = L.polygon(colombiaCoords, {
            color: '#333',
            weight: 1.5,
            fillColor: '#f0f0f0',
            fillOpacity: 0.3
        }).addTo(map);

        // Crear colección para almacenar los círculos de los departamentos
        const departamentoCirculos = [];
        
        // Crear colección para almacenar los marcadores de los municipios
        const municipioMarcadores = [];
        
        // Función para obtener color según valor normalizado (mejorada)
        function getColor(value) {
            // Nueva escala de azules que evita colores demasiado claros
            if (value < 0.1) {
                return '#9ecae1'; // Valor mínimo que sigue siendo visible
            } else if (value < 0.3) {
                return '#6baed6';
            } else if (value < 0.5) {
                return '#4292c6';
            } else if (value < 0.7) {
                return '#2171b5';
            } else if (value < 0.9) {
                return '#08519c';
            } else {
                return '#084594';
            }
        }
        
        // Variables globales para almacenar conteos
        let conteoMunicipios = {};
        let conteoDepartamentos = {};
        
        // Función para actualizar la interfaz con los datos procesados
        function actualizarUI(datos) {
            // Calcular conteo por municipio
            conteoMunicipios = {};
            datos.forEach(dato => {
                conteoMunicipios[dato.municipio] = (conteoMunicipios[dato.municipio] || 0) + 1;
            });
            
            // Calcular conteo por departamento
            conteoDepartamentos = {};
            datos.forEach(dato => {
                const codDepartamento = dato.codDepartamento;
                
                // Verificar si es un departamento oficial
                if (codigosANombresOficiales[codDepartamento]) {
                    conteoDepartamentos[codDepartamento] = (conteoDepartamentos[codDepartamento] || 0) + 1;
                }
            });
            
            // Convertir a arrays para ordenar
            const municipiosArray = Object.entries(conteoMunicipios)
                .map(([municipio, cantidad]) => ({ municipio, cantidad }))
                .sort((a, b) => b.cantidad - a.cantidad);
            
            // Crear array de departamentos solo con los departamentos oficiales presentes en los datos
            const departamentosArray = Object.entries(conteoDepartamentos)
                .map(([codigo, cantidad]) => {
                    const nombreOficial = codigosANombresOficiales[codigo] || `Departamento ${codigo}`;
                    const capital = departamentosOficiales[nombreOficial] || '';
                    
                    return {
                        codigo,
                        departamento: nombreOficial,
                        capital,
                        cantidad
                    };
                })
                .sort((a, b) => b.cantidad - a.cantidad);
                
            // Contar departamentos presentes en los datos
            const departamentosPresentes = departamentosArray.length;
            
            // Actualizar los números en las estadísticas
            document.getElementById('total-registros').textContent = datos.length.toLocaleString();
            document.getElementById('total-municipios').textContent = municipiosArray.length.toLocaleString();
            document.getElementById('total-departamentos').textContent = departamentosPresentes;
            
            // Actualizar estadísticas en el panel de pantalla completa
            document.getElementById('total-registros-fs').textContent = datos.length.toLocaleString();
            document.getElementById('total-municipios-fs').textContent = municipiosArray.length.toLocaleString();
            document.getElementById('total-departamentos-fs').textContent = departamentosPresentes;
            
            // Actualizar el contador de departamentos visualizado
            document.getElementById('dept-count').textContent = departamentosPresentes;
            document.getElementById('dept-total').textContent = TOTAL_DEPARTAMENTOS_OFICIALES;
            document.getElementById('dept-count-fs').textContent = departamentosPresentes;
            document.getElementById('dept-total-fs').textContent = TOTAL_DEPARTAMENTOS_OFICIALES;
            
            // Actualizar las estadísticas principales
            if (municipiosArray.length > 0) {
                document.getElementById('stat-principal').textContent = municipiosArray[0].municipio;
                document.getElementById('stat-principal-value').textContent = municipiosArray[0].cantidad.toLocaleString();
            }
            
            if (departamentosArray.length > 0) {
                document.getElementById('stat-depto').textContent = departamentosArray[0].departamento;
                document.getElementById('stat-depto-value').textContent = departamentosArray[0].cantidad.toLocaleString();
            }
            
            // Actualizar la lista de top municipios con elementos clicables
            const topMunicipiosHtml = municipiosArray.slice(0, 10).map((item, index) => `
                <div class="clickable-item" data-tipo="municipio" data-nombre="${item.municipio}">
                    <span class="item-name">${index + 1}. ${item.municipio}</span>
                    <span class="item-value">${item.cantidad.toLocaleString()}</span>
                </div>
            `).join('');
            
            document.getElementById('top-municipios').innerHTML = topMunicipiosHtml;
            document.getElementById('top-municipios-fs').innerHTML = topMunicipiosHtml;
            
            // Actualizar la lista de top departamentos con elementos clicables
            const topDepartamentosHtml = departamentosArray.slice(0, 5).map((item, index) => `
                <div class="clickable-item" data-tipo="departamento" data-codigo="${item.codigo}" data-nombre="${item.departamento}">
                    <span class="item-name">${index + 1}. ${item.departamento}</span>
                    <span class="item-value">${item.cantidad.toLocaleString()}</span>
                </div>
            `).join('');
            
            document.getElementById('top-departamentos').innerHTML = topDepartamentosHtml;
            document.getElementById('top-departamentos-fs').innerHTML = topDepartamentosHtml;
            
            // Actualizar el menú desplegable de todos los lugares
            const lugaresListHtml = municipiosArray.map((item, index) => `
                <div class="lugar-item" data-tipo="municipio" data-nombre="${item.municipio}">
                    <span>${item.municipio}</span>
                    <span class="count">${item.cantidad.toLocaleString()}</span>
                </div>
            `).join('');
            
            document.getElementById('lugares-list').innerHTML = lugaresListHtml;
            document.getElementById('lugares-count').textContent = `Todos los lugares (${municipiosArray.length})`;
            
            // También actualizar el menú de lugares en pantalla completa
            document.getElementById('lugares-list-fs').innerHTML = lugaresListHtml;
            document.getElementById('lugares-count-fs').textContent = `Todos los lugares (${municipiosArray.length})`;
            
            // Crear lista de departamentos para el menú desplegable (solo departamentos presentes)
            const departamentosListHtml = departamentosArray
                .map((item) => {
                    // Obtener un color para el departamento basado en la cantidad normalizada
                    const normalizedValue = item.cantidad / Math.max(...departamentosArray.map(d => d.cantidad));
                    const color = getColor(normalizedValue);
                    
                    // Incluir la capital si está disponible
                    const capitalText = item.capital ? ` (${item.capital})` : '';
                    
                    return `
                    <div class="departamento-item" data-tipo="departamento" data-codigo="${item.codigo}" data-nombre="${item.departamento}">
                        <div class="departamento-color" style="background-color: ${color};"></div>
                        <span>${item.departamento}${capitalText}</span>
                    </div>
                    `;
                }).join('');
            
            document.getElementById('departamentos-list').innerHTML = departamentosListHtml;
            document.getElementById('departamentos-list-fs').innerHTML = departamentosListHtml;
            
            // Agregar eventos a los elementos clicables después de crear el HTML
            document.querySelectorAll('.clickable-item, .lugar-item, .departamento-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tipo = this.dataset.tipo;
                    const nombre = this.dataset.nombre;
                    const codigo = this.dataset.codigo;
                    
                    if (tipo === 'municipio') {
                        enfocarMunicipio(nombre);
                    } else if (tipo === 'departamento') {
                        enfocarDepartamento(codigo, nombre);
                    }
                });
            });
            
            // Encontrar el valor máximo para normalizar los colores y tamaños
            const maxDeptoValue = Math.max(...departamentosArray.map(d => d.cantidad));
            
            // Crear círculos para departamentos con colores mejorados
            departamentosArray.forEach(depto => {
                if (coordsDepartamentos[depto.codigo]) {
                    const [lat, lng] = coordsDepartamentos[depto.codigo];
                    
                    // Normalizar valor para color (uso de la nueva función de color)
                    const colorValue = depto.cantidad / maxDeptoValue;
                    const color = getColor(colorValue);
                    
                    // Tamaño proporcional a la cantidad (mínimo más visible)
                    const radio = 20 + (depto.cantidad / maxDeptoValue) * 35;
                    
                    const circle = L.circle([lat, lng], {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.8,
                        radius: radio * 1000  // Convertir a metros para Leaflet
                    }).addTo(map);
                    
                    // Añadir tooltip al círculo
                    circle.bindTooltip(`
                        <div class="info-box">
                            <div class="info-title">${depto.departamento}</div>
                            <div class="info-content">
                                Registros: <span class="info-value">${depto.cantidad.toLocaleString()}</span><br>
                                Porcentaje: <span class="info-value">${(depto.cantidad / datos.length * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `, { permanent: false, direction: 'top' });
                    
                    departamentoCirculos.push(circle);
                }
            });
            
            // Crear marcadores para los top municipios con colores más visibles
            municipiosArray.slice(0, 15).forEach(muni => {
                if (coordsMunicipios[muni.municipio]) {
                    const [lat, lng] = coordsMunicipios[muni.municipio];
                    
                    // Tamaño proporcional a la cantidad (mínimo más visible)
                    const tamaño = 8 + (muni.cantidad / municipiosArray[0].cantidad) * 12;
                    
                    // Crear icono personalizado
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #ff5050; border-radius: 50%; width: ${tamaño}px; height: ${tamaño}px; border: 2px solid white;"></div>`,
                        iconSize: [tamaño, tamaño],
                        iconAnchor: [tamaño/2, tamaño/2]
                    });
                    
                    const marker = L.marker([lat, lng], { icon }).addTo(map);
                    
                    // Añadir popup al marcador
                    marker.bindPopup(`
                        <div class="info-box">
                            <div class="info-title">${muni.municipio}</div>
                            <div class="info-content">
                                Registros: <span class="info-value">${muni.cantidad.toLocaleString()}</span><br>
                                Porcentaje: <span class="info-value">${(muni.cantidad / datos.length * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `);
                    
                    municipioMarcadores.push(marker);
                }
            });
            
            // Ocultar mensaje de carga
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(el => el.style.display = 'none');
        }

        // Datos de muestra actualizados con los mostrados en la imagen
        const textoDemo = `25245\tEL COLEGIO
5045\tAPARTADO
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25290\tFUSAGASUGA
11001\tBOGOTA D.C.
25290\tFUSAGASUGA
25743\tSILVANIA
25743\tSILVANIA
11001\tBOGOTA D.C.
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25535\tPASCA
25649\tSAN BERNARDO
25290\tFUSAGASUGA
25053\tARBELAEZ
25506\tVENECIA (OSPINA PEREZ)
25312\tGRANADA
11001\tBOGOTA D.C.
25290\tFUSAGASUGA
11001\tBOGOTA D.C.
11001\tBOGOTA D.C.
81001\tARAUCA
25524\tPANDI
25290\tFUSAGASUGA
25290\tFUSAGASUGA
25290\tFUSAGASUGA
11001\tBOGOTA D.C.
11001\tBOGOTA D.C.`;

        // Funciones para enfocar municipios y departamentos en el mapa
        function enfocarMunicipio(nombreMunicipio) {
            if (coordsMunicipios[nombreMunicipio]) {
                const [lat, lng] = coordsMunicipios[nombreMunicipio];
                
                // Moverse a la ubicación del municipio con animación
                map.flyTo([lat, lng], 11, {
                    animate: true,
                    duration: 1.5
                });
                
                // Buscar el marcador correspondiente y mostrar su popup
                const marcador = municipioMarcadores.find(m => {
                    const popupContent = m.getPopup().getContent();
                    return popupContent.includes(nombreMunicipio);
                });
                
                if (marcador) {
                    // Agregar clase para resaltar el marcador
                    marcador._icon.classList.add('marker-active');
                    marcador.openPopup();
                    
                    // Quitar la clase después de un tiempo
                    setTimeout(() => {
                        if (marcador._icon) {
                            marcador._icon.classList.remove('marker-active');
                        }
                    }, 3000);
                } else {
                    // Si no hay marcador, crear uno temporal con la información
                    const municipioData = Object.entries(conteoMunicipios)
                        .find(([municipio]) => municipio === nombreMunicipio);
                    
                    if (municipioData) {
                        const [municipio, cantidad] = municipioData;
                        const porcentaje = (cantidad / datos.length * 100).toFixed(1);
                        
                        const tempMarker = L.marker([lat, lng]).addTo(map);
                        tempMarker.bindPopup(`
                            <div class="info-box">
                                <div class="info-title">${municipio}</div>
                                <div class="info-content">
                                    Registros: <span class="info-value">${cantidad.toLocaleString()}</span><br>
                                    Porcentaje: <span class="info-value">${porcentaje}%</span>
                                </div>
                            </div>
                        `).openPopup();
                        
                        // Eliminar el marcador después de un tiempo
                        setTimeout(() => {
                            map.removeLayer(tempMarker);
                        }, 5000);
                    }
                }
            }
        }
        
        function enfocarDepartamento(codigoDepartamento, nombreDepartamento) {
            if (coordsDepartamentos[codigoDepartamento]) {
                const [lat, lng] = coordsDepartamentos[codigoDepartamento];
                
                // Moverse a la ubicación del departamento con animación
                map.flyTo([lat, lng], 8, {
                    animate: true,
                    duration: 1.5
                });
                
                // Buscar el círculo correspondiente y mostrar su tooltip
                const circulo = departamentoCirculos.find(c => {
                    const tooltipContent = c.getTooltip().getContent();
                    return tooltipContent.includes(nombreDepartamento);
                });
                
                if (circulo) {
                    // Resaltar el círculo temporalmente
                    const originalOptions = {
                        fillOpacity: circulo.options.fillOpacity,
                        weight: circulo.options.weight
                    };
                    
                    circulo.setStyle({
                        fillOpacity: 0.9,
                        weight: 3
                    });
                    
                    circulo.openTooltip();
                    
                    // Restaurar el estilo original después de un tiempo
                    setTimeout(() => {
                        circulo.setStyle(originalOptions);
                    }, 3000);
                } else {
                    // Si no hay círculo, crear uno temporal con la información
                    const deptoData = Object.entries(conteoDepartamentos)
                        .find(([codigo]) => codigo === codigoDepartamento);
                    
                    if (deptoData) {
                        const [codigo, cantidad] = deptoData;
                        const porcentaje = (cantidad / datos.length * 100).toFixed(1);
                        
                        const tempCircle = L.circle([lat, lng], {
                            color: '#333',
                            weight: 2,
                            fillColor: '#2980b9',
                            fillOpacity: 0.8,
                            radius: 30000
                        }).addTo(map);
                        
                        tempCircle.bindTooltip(`
                            <div class="info-box">
                                <div class="info-title">${nombreDepartamento}</div>
                                <div class="info-content">
                                    Registros: <span class="info-value">${cantidad.toLocaleString()}</span><br>
                                    Porcentaje: <span class="info-value">${porcentaje}%</span>
                                </div>
                            </div>
                        `, { permanent: true }).openTooltip();
                        
                        // Eliminar el círculo después de un tiempo
                        setTimeout(() => {
                            map.removeLayer(tempCircle);
                        }, 5000);
                    }
                }
            }
        }
        
        // Función para cargar y procesar el archivo
        async function cargarArchivo() {
            // Lista de posibles rutas para el archivo Datos.txt
            const posiblesRutas = [
                'Datos.txt',
                './Datos.txt',
                '../Datos.txt',
                'datos/Datos.txt',
                './datos/Datos.txt'
            ];
            
            // Intentar cada una de las rutas posibles
            for (const ruta of posiblesRutas) {
                try {
                    console.log('Intentando cargar desde:', ruta);
                    const response = await fetch(ruta);
                    
                    if (response.ok) {
                        const texto = await response.text();
                        const datosProcessed = procesarDatos(texto);
                        actualizarUI(datosProcessed);
                        console.log('Datos cargados exitosamente desde:', ruta);
                        return; // Terminar si se cargó correctamente
                    }
                } catch (e) {
                    console.warn('No se pudo cargar desde:', ruta);
                }
            }

            // Si no se pudo cargar, mostrar el selector de archivos
            document.getElementById('file-input-container').style.display = 'block';
            
            // Cargar los datos de muestra mientras tanto
            const datosProcessed = procesarDatos(textoDemo);
            actualizarUI(datosProcessed);
            console.log('Usando datos de demostración');
        }

        // Evento para procesar el archivo seleccionado manualmente
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const texto = event.target.result;
                    const datosProcessed = procesarDatos(texto);
                    
                    // Limpiar mapa antes de actualizar
                    departamentoCirculos.forEach(circle => map.removeLayer(circle));
                    departamentoCirculos.length = 0;
                    
                    municipioMarcadores.forEach(marker => map.removeLayer(marker));
                    municipioMarcadores.length = 0;
                    
                    actualizarUI(datosProcessed);
                };
                reader.readAsText(file);
            }
        });

        // Funcionalidad de pantalla completa
        let enPantallaCompleta = false;
        const mapElement = document.getElementById('map');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const statsPanel = document.getElementById('stats-panel');
        const statsToggle = document.getElementById('stats-toggle');
        const statsClose = document.getElementById('stats-close');

        // Función para activar/desactivar pantalla completa
        function toggleFullscreen() {
            if (!enPantallaCompleta) {
                // Activar pantalla completa
                mapElement.classList.add('map-fullscreen');
                fullscreenBtn.innerHTML = '<span class="fullscreen-exit-icon"></span>Salir';
                
                // Pequeña pausa para asegurar que el panel se muestre correctamente
                setTimeout(() => {
                    statsPanel.classList.add('show');
                }, 50);
                enPantallaCompleta = true;
                
                // Mostrar el botón para mostrar/ocultar estadísticas y abrir el panel automáticamente
                statsToggle.classList.add('active');
                statsPanel.classList.add('active');
                statsPanel.classList.add('show');
                statsToggle.innerHTML = 'Ocultar';
                
                // Hacer que el botón de estadísticas se atenúe después de un tiempo
                setTimeout(() => {
                    statsToggle.classList.add('fade-out');
                }, 3000);
                
                // Restaurar la opacidad al pasar el mouse
                statsToggle.addEventListener('mouseenter', function() {
                    this.classList.remove('fade-out');
                });
                
                statsToggle.addEventListener('mouseleave', function() {
                    if (statsPanel.classList.contains('show')) {
                        this.classList.add('fade-out');
                    }
                });
                
                // Notificar a Leaflet que el tamaño del contenedor ha cambiado
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            } else {
                // Desactivar pantalla completa
                mapElement.classList.remove('map-fullscreen');
                fullscreenBtn.innerHTML = '<span class="fullscreen-icon"></span>Pantalla completa';
                enPantallaCompleta = false;
                
                // Ocultar el panel de estadísticas y su botón
                statsToggle.classList.remove('active');
                statsPanel.classList.remove('active');
                statsPanel.classList.remove('show');
                
                // Notificar a Leaflet que el tamaño del contenedor ha cambiado
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }
        
        // Toggle para mostrar/ocultar el panel de estadísticas
        function toggleStatsPanel() {
            statsPanel.classList.toggle('show');
            
            // Cambiar el texto del botón
            if (statsPanel.classList.contains('show')) {
                statsToggle.innerHTML = 'Ocultar';
                setTimeout(() => {
                    statsToggle.classList.add('fade-out');
                }, 2000);
            } else {
                statsToggle.innerHTML = 'Estadísticas';
                statsToggle.classList.remove('fade-out');
            }
        }

        // Agregar evento de clic al botón de pantalla completa
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        // Agregar evento de clic al botón de estadísticas
        statsToggle.addEventListener('click', toggleStatsPanel);
        
        // Agregar evento de clic al botón de cerrar estadísticas
        statsClose.addEventListener('click', toggleStatsPanel);

        // Agregar soporte para la tecla ESC para salir de pantalla completa
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && enPantallaCompleta) {
                toggleFullscreen();
            }
        });

        // Configurar el menú desplegable de lugares
        function configurarMenuDesplegable() {
            // Configurar el menú desplegable principal
            configurarMenu(
                'lugares-dropdown-btn',
                'lugares-dropdown-content',
                'lugar-search',
                '.lugar-item'
            );
            
            // Configurar el menú desplegable en pantalla completa
            configurarMenu(
                'lugares-dropdown-btn-fs',
                'lugares-dropdown-content-fs',
                'lugar-search-fs',
                '.lugar-item'
            );
        }
        
        // Función genérica para configurar un menú desplegable
        function configurarMenu(btnId, contentId, searchId, itemSelector) {
            const dropdownBtn = document.getElementById(btnId);
            const dropdownContent = document.getElementById(contentId);
            const searchInput = document.getElementById(searchId);
            
            if (!dropdownBtn || !dropdownContent) return;
            
            const dropdownIcon = dropdownBtn.querySelector('.dropdown-icon');
            
            // Toggle del menú desplegable
            dropdownBtn.addEventListener('click', function() {
                dropdownContent.classList.toggle('show');
                if (dropdownIcon) dropdownIcon.classList.toggle('open');
            });
            
            // Cerrar el menú desplegable si se hace clic fuera de él
            document.addEventListener('click', function(event) {
                if (!dropdownBtn.contains(event.target) && !dropdownContent.contains(event.target)) {
                    dropdownContent.classList.remove('show');
                    if (dropdownIcon) dropdownIcon.classList.remove('open');
                }
            });
            
            // Filtrar lugares al escribir en el buscador
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchText = this.value.toLowerCase();
                    const items = dropdownContent.querySelectorAll(itemSelector);
                    
                    items.forEach(item => {
                        const text = item.querySelector('span:first-child').textContent.toLowerCase();
                        if (text.includes(searchText)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }
        
        // Iniciar la carga de datos y configurar las interacciones
        window.addEventListener('DOMContentLoaded', () => {
            cargarArchivo();
            configurarMenuDesplegable();
        });
    </script>
</body>
</html>